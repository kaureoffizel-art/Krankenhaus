<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Privatklinik Level 8</title>

<style>
body{
font-family:Segoe UI;
margin:0;
background:#f4f6f9;
transition:0.3s;
}

.dark{
background:#1e272e;
color:white;
}

header{
background:#2c3e50;
color:white;
padding:18px;
text-align:center;
font-size:20px;
}

.container{
max-width:1200px;
margin:auto;
padding:20px;
}

.card{
background:white;
padding:20px;
margin-bottom:20px;
border-radius:10px;
box-shadow:0 6px 20px rgba(0,0,0,0.15);
}

.dark .card{
background:#2f3640;
}

input,textarea,select{
width:100%;
padding:8px;
margin-bottom:10px;
border-radius:6px;
border:1px solid #ccc;
}

button{
padding:8px 14px;
border:none;
border-radius:6px;
cursor:pointer;
background:#3498db;
color:white;
margin-right:5px;
}

.danger{background:#e74c3c;}
.hidden{display:none;}

table{
width:100%;
border-collapse:collapse;
}

th,td{
border:1px solid #ddd;
padding:8px;
}

th{
background:#34495e;
color:white;
}
</style>
</head>
<body>

<header>
üè• Privatklinik ‚Äì Level 8 Command Center
<button onclick="toggleMode()">Dark Mode</button>
</header>

<div class="container">

<div id="loginBox" class="card">
<h3>Login</h3>
<input id="username" placeholder="Benutzer">
<input id="password" type="password" placeholder="Passwort">
<button onclick="login()">Einloggen</button>
</div>

<div id="main" class="hidden">

<div class="card">
<button onclick="logout()" class="danger">Logout</button>
</div>

<div class="card">
<h3>Statistik</h3>
<div id="stats"></div>
</div>

<div class="card">
<h3>Neuer Patient</h3>
<input id="pname" placeholder="Name">
<input id="palter" type="number" placeholder="Alter">
<input id="pdiagnose" placeholder="Diagnose">
<textarea id="pbehandlung" placeholder="Behandlung"></textarea>
<button onclick="savePatient()">Speichern</button>
</div>

<div class="card">
<h3>Patienten</h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Diagnose</th>
<th>Aktion</th>
</tr>
</thead>
<tbody id="patientTable"></tbody>
</table>
</div>

<div id="adminPanel" class="card hidden">
<h3>Benutzerverwaltung (Admin)</h3>
<input id="newUser" placeholder="Benutzername">
<input id="newPass" placeholder="Passwort">
<select id="newRole">
<option value="doctor">Doctor</option>
<option value="assistant">Assistant</option>
<option value="admin">Admin</option>
</select>
<button onclick="createUser()">Benutzer erstellen</button>
</div>

<div class="card">
<h3>Audit Log</h3>
<ul id="logList"></ul>
</div>

</div>
</div>

<script>

let currentUser=null;
let role=null;

async function hash(text){
const buffer = new TextEncoder().encode(text);
const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
return Array.from(new Uint8Array(hashBuffer))
.map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function initUsers(){
if(!localStorage.getItem("users")){
let adminPass=await hash("admin");
let users=[{username:"Admin",password:adminPass,role:"admin"}];
localStorage.setItem("users",JSON.stringify(users));
}
}

initUsers();

async function login(){
let u=username.value;
let p=await hash(password.value);
let users=JSON.parse(localStorage.getItem("users"));
let user=users.find(x=>x.username===u && x.password===p);

if(user){
currentUser=u;
role=user.role;
sessionStorage.setItem("user",u);
sessionStorage.setItem("role",role);
showMain();
}else alert("Login falsch");
}

function showMain(){
loginBox.classList.add("hidden");
main.classList.remove("hidden");
if(role==="admin") adminPanel.classList.remove("hidden");
loadPatients();
updateStats();
loadLog();
}

function logout(){
sessionStorage.clear();
location.reload();
}

function savePatient(){
let data=JSON.parse(localStorage.getItem("patients"))||[];
let patient={
id:Date.now(),
name:pname.value,
alter:palter.value,
diagnose:pdiagnose.value,
behandlung:pbehandlung.value,
erstelltVon:currentUser
};
data.push(patient);
localStorage.setItem("patients",JSON.stringify(data));
log("Patient erstellt: "+patient.name);
loadPatients();
updateStats();
}

function loadPatients(){
let data=JSON.parse(localStorage.getItem("patients"))||[];
patientTable.innerHTML="";
data.forEach(p=>{
let row=document.createElement("tr");
row.innerHTML=`
<td>${p.name}</td>
<td>${p.diagnose}</td>
<td>
<button onclick="pdfPatient(${p.id})">PDF</button>
${role==="admin"?`<button class="danger" onclick="deletePatient(${p.id})">L√∂schen</button>`:""}
</td>`;
patientTable.appendChild(row);
});
}

function deletePatient(id){
let data=JSON.parse(localStorage.getItem("patients"));
let p=data.find(x=>x.id===id);
data=data.filter(x=>x.id!==id);
localStorage.setItem("patients",JSON.stringify(data));
log("Patient gel√∂scht: "+p.name);
loadPatients();
updateStats();
}

function updateStats(){
let data=JSON.parse(localStorage.getItem("patients"))||[];
stats.innerHTML="Gesamt Patienten: "+data.length;
}

function log(text){
let logs=JSON.parse(localStorage.getItem("logs"))||[];
logs.push(new Date().toLocaleString()+" - "+currentUser+" - "+text);
localStorage.setItem("logs",JSON.stringify(logs));
loadLog();
}

function loadLog(){
let logs=JSON.parse(localStorage.getItem("logs"))||[];
logList.innerHTML="";
logs.slice().reverse().forEach(l=>{
let li=document.createElement("li");
li.textContent=l;
logList.appendChild(li);
});
}

async function createUser(){
let users=JSON.parse(localStorage.getItem("users"));
let hashed=await hash(newPass.value);
users.push({username:newUser.value,password:hashed,role:newRole.value});
localStorage.setItem("users",JSON.stringify(users));
alert("Benutzer erstellt");
}

function toggleMode(){
document.body.classList.toggle("dark");
}

function pdfPatient(id){
let data=JSON.parse(localStorage.getItem("patients"));
let p=data.find(x=>x.id===id);
let w=window.open();
w.document.write("<h2>Patientenakte</h2>");
w.document.write("Name: "+p.name+"<br>");
w.document.write("Alter: "+p.alter+"<br>");
w.document.write("Diagnose: "+p.diagnose+"<br>");
w.document.write("Behandlung: "+p.behandlung+"<br>");
w.print();
}

</script>
</body>
</html>
